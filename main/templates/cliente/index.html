<!DOCTYPE html>
<head>
    <title>Alerta do Tempo</title>
</head>
<body id="body">
    <h1>Olha esse Design</h1>
    <form action="" method="post" style="display:inline-grid;" id="formCadastro">
        {% csrf_token %}
        <label for="nome">Nome: </label><input type="text" id="nome" name="nome"/>
        <label for="celular">Celular: </label><input type="text" id="celular" name="celular"/>
        <label for="senha">Senha: </label><input type="password" id="senha" name="senha"/>
        <label for="estado">Estado: </label>
        <select name="estado" id="estado">
            {% for estado in estados %}
            <option value="{{ estado.id }}">{{ estado.sigla }}</option>
            {% endfor %}
        </select>
        <select name="municipio" id="municipio"></select>
        <br>
        <input type="submit" value="Enviar">
    </form>
</body>

<script>
    
    window.onload = function(ev){
        //Carrega DropDown de Munícipio assim que carrega a página
        populaMuncipio();
    }
    //Eventos
    //Submit do formulário
    document.getElementById("formCadastro").addEventListener("submit", submitForm);
    //OnChange do Estado
    document.getElementById("estado").addEventListener("change", populaMuncipio);

    let tokens = document.getElementsByName("csrfmiddlewaretoken");
    let csrf_token = tokens[0].getAttribute("value");

    //Submit do formulário
    function submitForm(event){
        
        event.preventDefault();
        
        let xhr = new XMLHttpRequest();
        var url = "{% url 'clienteCadastra' %}";

        xhr.open("POST", url, true);
        xhr.setRequestHeader("Accept", 'application/x-www-form-urlencoded');
        xhr.setRequestHeader("Content-Type", 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRF-Token', csrf_token);

        xhr.onload = () => respostaRequisicao(xhr.responseText);

        let data = new URLSearchParams(new FormData(event.target)).toString();
        console.log(data);

        xhr.send(data);
    };

    //Resposta para inserção do cadastro
    function respostaRequisicao(respostaJSON){
        var resposta = JSON.parse(respostaJSON);
        var body = document.getElementById("body");
        if(resposta['sucesso'] == true){
            body.innerHTML = "<h1>Sucesso!</h1>";
            body.animate([{opacity: 0, backgroundColor: "#fff"},
                        {opacity: 1, backgroundColor: "#0f0"}
                    ], { duration: 2000, fill: 'forwards' });
        }else{
            body.innerHTML = "<h1>Erro de Inserção!</h1>";
            body.animate([{opacity: 0, backgroundColor: "#fff"},
                        {opacity: 1, backgroundColor: "#f00"}
                    ], { duration: 2000, fill: 'forwards' });
        }
        
    }

    function populaMuncipio(event){
        
        let xhr = new XMLHttpRequest();
        var url = "{% url 'loadCidadesByEstado' %}";

        xhr.open("POST", url, true);
        xhr.setRequestHeader("Accept", 'application/json');
        xhr.setRequestHeader("Content-Type", 'application/json');

        xhr.onload = () => respostaPopulaMunicipio(xhr.response);
        let dados = {estado_id: document.getElementById('estado').value}
        let data = JSON.stringify(dados);
        xhr.send(data);
        
    }

    function respostaPopulaMunicipio(dadosJSON){
        var dados = JSON.parse(dadosJSON);
        console.log(dados);
        let select = document.getElementById('municipio');
        select.innerHTML = "";
        for (key in dados){
            var opt = document.createElement('option');
            opt.value = key;
            opt.innerHTML = dados[key]
            select.appendChild(opt);
        }
    }
</script>
</html>